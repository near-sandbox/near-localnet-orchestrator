# Checkpoint: 2025-12-31T01:10Z (Layer 1 bootstrapped, Layer 2 faucet deployed, core contracts pending)

This file is a **resume point** for the `.node0 → .localnet` migration work.

## Context

- **Goal**: Layer 1 + Layer 2 parity work to support `.localnet` accounts (`alice.localnet`, `wrap.localnet`, etc.)
- **Current branch**: `feature/node0-to-localnet-naming`
- **AWS account/region/profile**:
  - Account: `311843862895`
  - Region: `us-east-1`
  - Profile: `shai-sandbox-profile`

## Current deployed state (AWS)

### Layer 1 (NEAR Base)

- **Stacks**:
  - `near-localnet-common`
  - `near-localnet-infrastructure`
  - `near-localnet-install`
  - `near-localnet-sync`

- **CloudFormation outputs**:
  - **RPC URL**: `http://10.0.44.18:3030`
  - **Network ID**: `localnet`
  - **Instance ID**: `i-0b2ea52c4eda30139`
  - **Private IP**: `10.0.44.18`
  - **Public IP**: `98.82.192.107`
  - **VPC ID**: `vpc-04e3c6548301d9175`
  - **Security Group**: `sg-0a41e275b515fcf1a`

### Layer 2 (NEAR Services)

- **Faucet stack**: `near-localnet-faucet-v2`
  - Function name: `near-localnet-faucet`
  - Function ARN: `arn:aws:lambda:us-east-1:311843862895:function:near-localnet-faucet`

## Verified behaviors (what’s working)

### Layer 1 bootstrap (fresh deploy reliability)

On the EC2 instance, UserData completed successfully:

- **Marker**: `/var/log/near-init-complete.log` exists
- `/var/log/near-setup.log` contains:
  - `Patching genesis.json with localnet account (reallocating from node0)...`
  - `Localnet keypair stored in SSM`
  - `RPC endpoint responding`
  - `✅ Genesis contains localnet account`

### SSM parameters exist

- `/near-localnet/localnet-account-id` (String) → `localnet`
- `/near-localnet/localnet-account-key` (SecureString) → present (SSM “Version” shown as `3` in logs)

## Current blocker (why we’re not “done” yet)

### Core contracts are not deployed yet

The required `.localnet` contract accounts are currently missing:

- `wrap.localnet`
- `whitelist.localnet`
- `poolv1.localnet`

**Root cause**: the orchestrator’s “deploy core contracts” step is still using an ad-hoc `aws ssm send-command` payload which is fragile (newline escaping + `/bin/sh` parsing). This caused failures like:

- `Syntax error: redirection unexpected` (dash `/bin/sh` vs bash)
- near-cli-rs install path mismatch (tarball contains `near-cli-rs-x86_64-unknown-linux-gnu/near`)

## Next steps (exact resume plan)

1. **Make contract deployment structured and robust**
   - Replace the one-off `AWS-RunShellScript` payload with a dedicated **custom SSM Command document**.
   - The orchestrator should ensure the document exists/updated, then invoke it with parameters.

2. **Use near-cli-rs non-interactive commands (no prompts)**
   - Derive the **public key** from the `localnet` private key.
   - Create `wrap.localnet`, `whitelist.localnet`, `poolv1.localnet` using the **same public key** so the same private key can sign subsequent deploy/init.
   - Deploy contract WASM using `near contract deploy <ACCOUNT_ID> use-file ... without-init-call ... send`
   - Initialize contracts with `near contract call-function as-transaction ... send`

3. **Re-run Layer 2 deployment**
   - `npx near-orchestrator deploy near_services --force`

4. **Verification gates (before merge)**
   - Faucet creates `alice.localnet` (mode `createAccount`)
   - RPC `view_account` confirms `alice.localnet`
   - RPC `view_account` confirms `wrap.localnet`, `whitelist.localnet`, `poolv1.localnet` exist and have contract code (non-default `code_hash`)

5. **Merge**
   - Merge feature branch → `main` in:
     - `AWSNodeRunner`
     - `near-localnet-services`
     - `near-localnet-orchestrator`

## Useful commands (manual sanity)

- List NEAR stacks:
  - `aws cloudformation list-stacks --profile shai-sandbox-profile --region us-east-1 --query "StackSummaries[?contains(StackName, 'near-localnet') && StackStatus!='DELETE_COMPLETE'].[StackName,StackStatus]" --output table`
- Confirm Layer 1 outputs:
  - `aws cloudformation describe-stacks --stack-name near-localnet-sync --profile shai-sandbox-profile --region us-east-1 --query "Stacks[0].Outputs" --output table`
- Confirm SSM key exists:
  - `aws ssm get-parameter --name /near-localnet/localnet-account-key --with-decryption --profile shai-sandbox-profile --region us-east-1 --query Parameter.Value --output text`


